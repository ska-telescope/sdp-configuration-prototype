#
# Note: Tests can be run locally with
#   gitlab-runner exec <executor, eg. docker> <stage name>
#
stages:
  - test
  - post_test
  - build_0
  - build_1
  - build_2
  - build_3
  - deploy

# ============================================================================
# Run linters & tests
# ============================================================================

# Test the SDPSubarray device
test_subarray_device:
    stage: test
    tags: [docker]
    image: skaorca/pytango_ska_dev:latest
    before_script:
      - pipenv install jsonschema
    script:
      - ./scripts/run_test.sh
          src/tango_sdp_subarray
          --gherkin-terminal-reporter
          -vv
          --cucumber-json=cucumber.json
      - mv .coverage $CI_JOB_NAME.coverage
    artifacts:
      paths:
      - cucumber.json
      - $CI_JOB_NAME.coverage
      expire_in: 1 week

# Test the SDPMaster device.
test_master_device:
    stage: test
    tags: [docker]
    image: skaorca/pytango_ska_dev:latest
    script:
      - ./scripts/run_test.sh src/tango_sdp_master
      - mv .coverage $CI_JOB_NAME.coverage
    artifacts:
      paths:
        - $CI_JOB_NAME.coverage

# Test the configuration database
config_db_tests:
    stage: test
    image: skaorca/pytango_ska_dev:latest
    services:
      - name: quay.io/coreos/etcd:latest
        alias: etcd
        command:
          - /usr/local/bin/etcd
          - "--advertise-client-urls=http://0.0.0.0:2379"
          - "--listen-client-urls=http://0.0.0.0:2379"
          - "--initial-advertise-peer-urls=http://0.0.0.0:2380"
          - "--listen-peer-urls=http://0.0.0.0:2380"
          - "--initial-cluster=default=http://0.0.0.0:2380"
    variables:
      SDP_TEST_HOST: etcd
    script:
      - pipenv install etcd3-py
      - ./scripts/run_test.sh src/config_db
      - mv .coverage $CI_JOB_NAME.coverage
    artifacts:
      paths:
        - $CI_JOB_NAME.coverage

# Build documentation
build_docs:
  stage: test
  when: manual
  before_script:
    - pip install -r docs/requirements.txt
  script:
    - make -C docs html
  artifacts:
    paths: [docs/build/html/]
    expire_in: 1 day

# ============================================================================
# Generate test reports
# ============================================================================


# Generate combined test coverage report
coverage_report:
  stage: post_test
  tags: [docker]
  image: python:latest
  before_script:
    - pip install coverage
  script:
    - coverage combine *.coverage
    - coverage report
    - coverage html
  coverage: '/TOTAL\s+\d+\s+\d+\s+\d+\s+\d+\s+(\d+\%)/'
  artifacts:
    paths: [htmlcov/]
    expire_in: 1 week

# Update XRay links in JIRA. This is done only for the master
xray_report:
  stage: post_test
  tags: [docker]
  image: python:latest
  only: [master]
  script:
    - 'curl -X POST -H "Content-Type: application/json"
         -H "Authorization: Basic $JIRA_AUTH"
         --data @cucumber.json
         https://jira.skatelescope.org/rest/raven/1.0/import/execution/cucumber'
  retry: 2 # In case JIRA doesn't work first time

# ============================================================================
# Build and Push docker images
# ============================================================================

# Build and push the `pytango_base` image.
# Only build when there is a change.
build_pytango_base:
  stage: build_0
#  tags: [shell]
  tags: [docker]
  image: docker:stable
  services:
    - docker:dind
  only:
    changes:
      - docker/pytango_base
  before_script:
    - apk add make git
    - docker login -u $NEXUS_USER -p $NEXUS_PASS $NEXUS_HOST
  script:
    - cd docker/pytango_base
    - make DOCKER_REGISTRY_HOST=$NEXUS_HOST DOCKER_REGISTRY_USER=$CI_PROJECT_NAME DOCKER_BUILD_ARGS="--no-cache" build
    - make DOCKER_REGISTRY_HOST=$NEXUS_HOST DOCKER_REGISTRY_USER=$CI_PROJECT_NAME tag
    - make DOCKER_REGISTRY_HOST=$NEXUS_HOST DOCKER_REGISTRY_USER=$CI_PROJECT_NAME push
  retry: 2

# Build and push the `pytango_ska_base` image.
# Only build when there is a change.
build_pytango_ska_base:
  stage: build_1
#  tags: [shell]
  tags: [docker]
  image: docker:stable
  services:
    - docker:dind
  only:
    changes:
      - docker/pytango_base
      - docker/pytango_ska_base
  before_script:
    - apk add make git
    - docker login -u $NEXUS_USER -p $NEXUS_PASS $NEXUS_HOST
  script:
    - cd docker/pytango_ska_base
    - make DOCKER_REGISTRY_HOST=$NEXUS_HOST DOCKER_REGISTRY_USER=$CI_PROJECT_NAME DOCKER_BUILD_ARGS="--no-cache" build
    - make DOCKER_REGISTRY_HOST=$NEXUS_HOST DOCKER_REGISTRY_USER=$CI_PROJECT_NAME tag
    - make DOCKER_REGISTRY_HOST=$NEXUS_HOST DOCKER_REGISTRY_USER=$CI_PROJECT_NAME push
  retry: 2

# Build and push the `pytango_ska_dev` image.
# Only build when there is a change.
build_pytango_ska_dev:
  stage: build_2
#  tags: [shell]
  tags: [docker]
  image: docker:stable
  services:
    - docker:dind
  only:
    changes:
      - docker/pytango_base
      - docker/pytango_ska_base
      - docker/pytango_ska_dev
  before_script:
    - apk add make git
    - docker login -u $NEXUS_USER -p $NEXUS_PASS $NEXUS_HOST
  script:
    - cd docker/pytango_ska_dev
    - make DOCKER_REGISTRY_HOST=$NEXUS_HOST DOCKER_REGISTRY_USER=$CI_PROJECT_NAME DOCKER_BUILD_ARGS="--no-cache" build
    - make DOCKER_REGISTRY_HOST=$NEXUS_HOST DOCKER_REGISTRY_USER=$CI_PROJECT_NAME tag
    - make DOCKER_REGISTRY_HOST=$NEXUS_HOST DOCKER_REGISTRY_USER=$CI_PROJECT_NAME push
  retry: 2

# Build and push `tangods_sdp_master` image.
build_tangods_sdp_master:
  stage: build_3
#  tags: [shell]
  tags: [docker]
  image: docker:stable
  services:
    - docker:dind
  only:
    changes:
      - docker/pytango_base
      - docker/pytango_ska_base
      - src/tango_sdp_master
  before_script:
    - apk add make git
    - docker login -u $NEXUS_USER -p $NEXUS_PASS $NEXUS_HOST
  script:
    - cd src/tango_sdp_master
    - make DOCKER_REGISTRY_HOST=$NEXUS_HOST DOCKER_REGISTRY_USER=$CI_PROJECT_NAME DOCKER_BUILD_ARGS="--no-cache" build
    - make DOCKER_REGISTRY_HOST=$NEXUS_HOST DOCKER_REGISTRY_USER=$CI_PROJECT_NAME tag
    - make DOCKER_REGISTRY_HOST=$NEXUS_HOST DOCKER_REGISTRY_USER=$CI_PROJECT_NAME push
  retry: 2

# Build and push `tangods_sdp_subarray` image.
build_tangods_sdp_subarray:
  stage: build_3
#  tags: [shell]
  tags: [docker]
  image: docker:stable
  services:
    - docker:dind
#  only:
#    changes:
#      - docker/pytango_base
#      - docker/pytango_ska_base
#      - src/tango_sdp_subarray
  before_script:
    - apk add make git
    - docker login -u $NEXUS_USER -p $NEXUS_PASS $NEXUS_HOST
  script:
    - cd src/tango_sdp_subarray
    - make DOCKER_REGISTRY_HOST=$NEXUS_HOST DOCKER_REGISTRY_USER=$CI_PROJECT_NAME DOCKER_BUILD_ARGS="--no-cache" build
    - make DOCKER_REGISTRY_HOST=$NEXUS_HOST DOCKER_REGISTRY_USER=$CI_PROJECT_NAME tag
    - make DOCKER_REGISTRY_HOST=$NEXUS_HOST DOCKER_REGISTRY_USER=$CI_PROJECT_NAME push
  retry: 2

# ============================================================================
# Publish reports
# ============================================================================

# Generate gitlab pages. This is done only for the master.
pages:
  stage: deploy
  tags: [docker]
  image: python:latest
  only: [master]
  script:
    - cp -R htmlcov public/
  artifacts:
    paths: [public/]
    expire_in: 1 week
